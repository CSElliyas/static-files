!function(F){function n(e,t){var l=this,C=F.extend({},F.fn.signaturePad.defaults,t),r=F(e),c=F(C.canvas,r),o=c.get(0),s=null,u={x:null,y:null},p=[],d=!1,n=!1,a=!1,h=!1,f=30,g=f,m=0,v=[];function y(){clearTimeout(d),n=d=!1}function w(e,t){var n,a;if(e.preventDefault(),a=F(e.target).offset(),clearTimeout(d),d=!1,a=void 0!==e.changedTouches?(n=Math.floor(e.changedTouches[0].pageX-a.left),Math.floor(e.changedTouches[0].pageY-a.top)):(n=Math.floor(e.pageX-a.left),Math.floor(e.pageY-a.top)),u.x===n&&u.y===a)return!0;if(null===u.x&&(u.x=n),null===u.y&&(u.y=a),t&&(a+=t),s.beginPath(),s.moveTo(u.x,u.y),s.lineTo(n,a),s.lineCap=C.penCap,s.stroke(),s.closePath(),!0===C.drawBezierCurves){v.push({lx:n,ly:a,mx:u.x,my:u.y});t=4*C.bezierSkip;if(v.length>=t){var r=p.slice(p.length-t+2,p.length);for(i in s.strokeStyle=C.bgColour,r){var o=r[i];s.beginPath(),s.moveTo(o.mx,o.my),s.lineTo(o.lx,o.ly),s.lineCap=C.penCap,s.stroke(),s.closePath()}s.strokeStyle=C.penColour,O(v,s),v=v.slice(t-1,t)}}p.push({lx:n,ly:a,mx:u.x,my:u.y}),u.x=n,u.y=a,C.onDraw&&"function"==typeof C.onDraw&&C.onDraw.apply(l)}function b(e){e&&"touchend"!==e.type&&"touchcancel"!=e.type?w(e,1):(a?c.each(function(){this.removeEventListener("touchmove",w)}):c.unbind("mousemove.signaturepad"),0<p.length&&(C.onDrawEnd&&"function"==typeof C.onDrawEnd&&C.onDrawEnd.apply(l),v=[],x(),z(p,s,!1))),u.x=null,u.y=null,C.output&&0<p.length&&F(C.output,r).val(JSON.stringify(p))}function x(){s.clearRect(0,0,o.width,o.height),s.fillStyle=C.bgColour,s.fillRect(0,0,o.width,o.height),C.displayOnly||C.lineWidth&&(s.beginPath(),s.lineWidth=C.lineWidth,s.strokeStyle=C.lineColour,s.moveTo(C.lineMargin,C.lineTop),s.lineTo(o.width-C.lineMargin,C.lineTop),s.stroke(),s.closePath()),s.lineWidth=C.penWidth,s.strokeStyle=C.penColour}function I(){x(),F(C.output,r).val(""),p=[],b()}function D(e,t){null==u.x?w(e,1):w(e,t)}function M(e,t){a?t.addEventListener("touchmove",D,!1):c.bind("mousemove.signaturepad",D),w(e,1)}function S(e){h||(h=!0,F("input").blur(),void 0!==e.changedTouches&&(a=!0),a?(c.each(function(){this.addEventListener("touchend",b,!1),this.addEventListener("touchcancel",b,!1)}),c.unbind("mousedown.signaturepad")):(F(document).bind("mouseup.signaturepad",function(){n&&(b(),y())}),c.bind("mouseleave.signaturepad",function(e){n&&b(e),n&&!d&&(d=setTimeout(function(){b(),y()},500))}),c.each(function(){this.ontouchstart=null})))}function P(){F(C.typed,r).hide(),I(),c.each(function(){this.ontouchstart=function(e){e.preventDefault(),n=!0,S(e),M(e,this)}}),c.bind("mousedown.signaturepad",function(e){e.preventDefault(),n=!0,S(e),M(e)}),F(C.clear,r).bind("click.signaturepad",function(e){e.preventDefault(),I()}),F(C.typeIt,r).bind("click.signaturepad",function(e){e.preventDefault(),T()}),F(C.drawIt,r).unbind("click.signaturepad"),F(C.drawIt,r).bind("click.signaturepad",function(e){e.preventDefault()}),F(C.typeIt,r).removeClass(C.currentClass),F(C.drawIt,r).addClass(C.currentClass),F(C.sig,r).addClass(C.currentClass),F(C.typeItDesc,r).hide(),F(C.drawItDesc,r).show(),F(C.clear,r).show()}function T(){I(),h=!1,c.each(function(){this.removeEventListener&&(this.removeEventListener("touchend",b),this.removeEventListener("touchcancel",b),this.removeEventListener("touchmove",w)),this.ontouchstart&&(this.ontouchstart=null)}),F(document).unbind("mouseup.signaturepad"),c.unbind("mousedown.signaturepad"),c.unbind("mousemove.signaturepad"),c.unbind("mouseleave.signaturepad"),F(C.clear,r).unbind("click.signaturepad"),F(C.typed,r).show(),F(C.drawIt,r).bind("click.signaturepad",function(e){e.preventDefault(),P()}),F(C.typeIt,r).unbind("click.signaturepad"),F(C.typeIt,r).bind("click.signaturepad",function(e){e.preventDefault()}),F(C.output,r).val(""),F(C.drawIt,r).removeClass(C.currentClass),F(C.typeIt,r).addClass(C.currentClass),F(C.sig,r).removeClass(C.currentClass),F(C.drawItDesc,r).hide(),F(C.clear,r).hide(),F(C.typeItDesc,r).show(),g=f=F(C.typed,r).css("font-size").replace(/px/,"")}function E(e){var t=F(C.typed,r),n=e.replace(/>/g,"&gt;").replace(/</g,"&lt;").trim(),e=m,a=.5*g;if(m=n.length,t.html(n),n){if(e<m&&t.outerWidth()>o.width)for(;t.outerWidth()>o.width;)g--,t.css("font-size",g+"px");if(m<e&&t.outerWidth()+a<o.width&&g<f)for(;t.outerWidth()+a<o.width&&g<f;)g++,t.css("font-size",g+"px")}else t.css("font-size",f+"px")}function W(){var e=!0,t={drawInvalid:!1,nameInvalid:!1},n=[r,C],a=[t,r,C];return(C.onBeforeValidate&&"function"==typeof C.onBeforeValidate?C.onBeforeValidate:function(e,t){F("p."+t.errorClass,e).remove(),e.removeClass(t.errorClass),F("input, label",e).removeClass(t.errorClass)}).apply(l,n),C.drawOnly&&p.length<1&&(e=!(t.drawInvalid=!0)),""===F(C.name,r).val()&&(e=!(t.nameInvalid=!0)),(C.onFormError&&"function"==typeof C.onFormError?C.onFormError:function(e,t,n){e.nameInvalid&&(t.prepend(['<p class="',n.errorClass,'">',n.errorMessage,"</p>"].join("")),F(n.name,t).focus(),F(n.name,t).addClass(n.errorClass),F("label[for="+F(n.name).attr("id")+"]",t).addClass(n.errorClass)),e.drawInvalid&&t.prepend(['<p class="',n.errorClass,'">',n.errorMessageDraw,"</p>"].join(""))}).apply(l,a),e}function O(e,t){for(var n,a,i=[],r=[],o=0;o<e.length-1;o++)"object"==typeof e[o]&&"object"==typeof e[o+1]&&(n=e[o],a=e[o+1],n.mx==n.lx&&n.my==n.ly||(i.push(n),n.lx==a.mx&&n.ly==a.my||n.mx==a.lx&&n.my==a.ly||(r.push(i),i=[]),o==e.length-2&&(i.push(a),r.push(i))));var l=[];for(k=0;k<r.length;k++){var s=r[k].pop();r[k]=r[k].filter(function(e,t){return t%C.bezierSkip==0}),r[k].push(s);i=r[k];for(j=0;j<i.length;j++){var u=i[j],u=Math.abs(u.lx-u.mx)+Math.abs(u.ly-u.my);l.push(u)}}var d=stats(l);for(d.length=numeric.sum(l),d.mean*=3,d.deviation*=3,k=0;k<r.length;k++){var c=(i=r[k]).map(function(e){return[e.lx,e.ly]}),p=getBezierControlPoints(c);for(o in p){var h,f,g=p[o][0],m=p[o][1],v=p[o][2],y=p[o][3];!0===C.variableStrokeWidth&&(0<(h=(Math.abs(g[0]-m[0])+Math.abs(m[0]-v[0])+Math.abs(v[0]-y[0])+Math.abs(g[1]-m[1])+Math.abs(m[1]-v[1])+Math.abs(v[1]-y[1])-d.mean)/d.deviation)?f=3-h/2.5:h<=0&&(f=3-2*h)),t.beginPath(),t.moveTo(g[0],g[1]),t.bezierCurveTo(m[0],m[1],v[0],v[1],y[0],y[1]),t.lineWidth=C.penWidth,t.lineWidth=f,t.lineCap=C.penCap,t.stroke(),t.closePath()}}}function z(e,t,n){var a,i,r,o,l,s,u,d;for(d in C.autoscale?(i=a=0,r=F(c).width(),o=F(c).height(),F.each(e,function(e,t){a=Math.max(t.mx,t.lx,a),r=Math.min(t.mx,t.lx,r),i=Math.max(t.my,t.ly,i),o=Math.min(t.my,t.ly,o)}),u=(l=(a*=1.15)-(r*=.85))/(s=(i*=1.15)-(o*=.85)),u=c.width()/c.height()<u?c.width()/l:c.height()/s,t.translate(-r*u,-o*u),t.scale.apply(t,[u,u]),t.translate((c.width()/u-l)/2,(c.height()/u-s)/2)):t.scale.apply(t,C.scale),e)"object"==typeof e[d]&&(!1===C.drawBezierCurves&&(t.beginPath(),t.moveTo(e[d].mx,e[d].my),t.lineTo(e[d].lx,e[d].ly),t.lineCap=C.penCap,t.stroke(),t.closePath()),n&&p.push({lx:e[d].lx,ly:e[d].ly,mx:e[d].mx,my:e[d].my}));!0===C.drawBezierCurves&&O(e,t)}F.extend(l,{init:function(){parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||[0,"4_2"])[1].replace("_","."))<4.1&&(F.fn.Oldoffset=F.fn.offset,F.fn.offset=function(){var e=F(this).Oldoffset();return e.top-=window.scrollY,e.left-=window.scrollX,e}),F(C.typed,r).bind("selectstart.signaturepad",function(e){return F(e.target).is(":input")}),c.bind("selectstart.signaturepad",function(e){return F(e.target).is(":input")}),!o.getContext&&FlashCanvas&&FlashCanvas.initElement(o),o.getContext&&(s=o.getContext("2d"),F(C.sig,r).show(),C.displayOnly||(C.drawOnly||(F(C.name,r).bind("keyup.signaturepad",function(){E(F(this).val())}),F(C.name,r).bind("blur.signaturepad",function(){E(F(this).val())}),F(C.drawIt,r).bind("click.signaturepad",function(e){e.preventDefault(),P()})),(C.drawOnly||"drawIt"===C.defaultAction?P:T)(),C.validateFields&&(F(e).is("form")?F(e):F(e).parents("form")).bind("submit.signaturepad",W),F(C.sigNav,r).show()))},updateOptions:function(e){F.extend(C,e)},regenerate:function(e){l.clearCanvas(),F(C.typed,r).hide(),"string"==typeof e&&(e=JSON.parse(e)),z(e,s,!0),C.output&&0<F(C.output,r).length&&F(C.output,r).val(JSON.stringify(p))},clearCanvas:function(){I()},getSignature:function(){return p},getSignatureString:function(){return JSON.stringify(p)},getSignatureImage:function(){var e,t=document.createElement("canvas"),n=null;return t.style.position="absolute",t.style.top="-999em",t.width=o.width,t.height=o.height,document.body.appendChild(t),!t.getContext&&FlashCanvas&&FlashCanvas.initElement(t),(n=t.getContext("2d")).fillStyle=C.bgColour,n.fillRect(0,0,o.width,o.height),n.lineWidth=C.penWidth,n.strokeStyle=C.penColour,z(p,n),e=t.toDataURL.apply(t,arguments),document.body.removeChild(t),t=null,e},validateForm:W})}F.fn.signaturePad=function(e){var t=null;return this.each(function(){F.data(this,"plugin-signaturePad")?(t=F.data(this,"plugin-signaturePad")).updateOptions(e):((t=new n(this,e)).init(),F.data(this,"plugin-signaturePad",t))}),t},F.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:!1,drawOnly:!1,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:!0,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",onBeforeValidate:null,onFormError:null,onDraw:null,onDrawEnd:null,scale:[1,1],autoscale:!1,drawBezierCurves:!1,variableStrokeWidth:!1,bezierSkip:4}}(jQuery);